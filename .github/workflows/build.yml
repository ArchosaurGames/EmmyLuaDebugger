name: Emmy Debugger Core

on: [push]

jobs:
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v1
    
    - name: Build x86
      run: |
        mkdir x86
        cd x86
        cmake ..  -A Win32 -G "Visual Studio 17 2022"
        cmake --build . --config RelWithDebInfo --target install
    
    - name: Upload x86
      uses: actions/upload-artifact@v1.0.0
      with:
        name: win32-x86
        path: x86/install/bin

    - name: Build x64
      run: |
        mkdir x64
        cd x64
        cmake ../ -G "Visual Studio 17 2022"
        cmake --build . --config RelWithDebInfo --target install
    
    - name: Upload x64
      uses: actions/upload-artifact@v1.0.0
      with:
        name: win32-x64
        path: x64/install/bin

  build-other:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - { os: ubuntu-latest, target: linux, platform: linux-x64}
          - { os: macos-latest, target: darwin, platform: darwin-x64}
          - { os: macos-latest, target: darwin, platform: darwin-arm64}
    steps:
    - uses: actions/checkout@v1

    - name: Build
      run: |
        mkdir build
        cd build
        cmake ..
        cmake --build . --config Release
        cmake --install . --config Release --prefix ${{ github.workspace }}/artifact/
    - name: Upload
      uses: actions/upload-artifact@v2
      with:
        name: ${{ matrix.platform }}
        path: ${{ github.workspace }}/artifact/bin
 
  upload-release:
    name: Upload Release
    if: startsWith(github.ref, 'refs/tags/')
    needs: [build-windows, build-other]
    runs-on: [ubuntu-18.04]
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Download
        uses: actions/download-artifact@v2
      - name: Display structure of downloaded files
        run: ls -R   
      - name: zip win32-x64
        uses: TheDoctor0/zip-release@master
        with:
          filename: win32-x64.zip
          directory: win32-x64
          path: |
            EasyHook.dll
            emmy_core.dll
            emmy_hook.dll
            emmy_tool.exe

      - name: zip win32-x86
        uses: TheDoctor0/zip-release@master
        with:
          filename: win32-x86.zip
          directory: win32-x86
          path: |
            EasyHook.dll
            emmy_core.dll
            emmy_hook.dll
            emmy_tool.exe
      - name: zip linux-x64
        uses: TheDoctor0/zip-release@master
        with:
          filename: linux-x64.zip
          path: linux-x64/emmy_core.so
      - name: zip darwin-x64
        uses: TheDoctor0/zip-release@master
        with:
          filename: darwin-x64.zip
          path: darwin-x64/emmy_core.dylib   
      - name: zip darwin-arm64
        uses: TheDoctor0/zip-release@master
        with:
          filename: darwin-arm64.zip
          path: darwin-arm64/emmy_core.dylib
      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          name: EmmyLuaDebugger
          draft: false
          generate_release_notes: true
          files: |
            win32-x64.zip
            win32-x86.zip
            darwin-arm64.zip
            darwin-x64.zip
            linux-x64.zip
          token: ${{ secrets.RELEASE }}
